<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vibe Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #preview-frame { width: 100%; height: 100%; border: none; background: white; }
        @keyframes thinking-bounce {
            0%, 80%, 100% { opacity: 0.2; transform: translateY(0); }
            40% { opacity: 1; transform: translateY(-3px); }
        }
        .thinking-dot { animation: thinking-bounce 1.2s infinite ease-in-out; }
        .thinking-dot:nth-child(2) { animation-delay: 0.2s; }
        .thinking-dot:nth-child(3) { animation-delay: 0.4s; }
    </style>
</head>
<body class="h-screen flex flex-col bg-zinc-900 text-white overflow-hidden">

    <header class="p-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-950">
        <h1 class="font-bold tracking-tighter text-xl">SORO<span class="text-blue-500">BORUO</span></h1>
        <div class="space-x-2 flex">
            <button onclick="toggleSettings()" class="px-3 py-1 bg-zinc-800 rounded hover:bg-zinc-700 text-sm">Settings</button>
            <button onclick="publishToGithub()" id="publish-btn" class="px-4 py-1 bg-blue-600 rounded hover:bg-blue-500 font-bold text-sm">Publish to GitHub</button>
        </div>
    </header>

    <main id="main-panel" class="flex-1 flex overflow-hidden">
        <div id="sidebar" class="flex flex-col bg-zinc-950" style="width: 33%;">
            <div id="chat-history" class="flex-1 p-4 overflow-y-auto space-y-4 text-sm">
                <div class="text-zinc-500 italic">Enter your API keys in Settings to start vibing...</div>
            </div>
            <div class="p-4 border-t border-zinc-800">
                <textarea id="vibe-input" placeholder="e.g. 'Make it a dark mode portfolio with neon pink accents...'"
                    class="w-full bg-zinc-900 border border-zinc-700 rounded p-2 focus:outline-none focus:border-blue-500 h-24 resize-none text-sm"></textarea>
                <button onclick="sendVibe()" id="send-btn" class="w-full mt-2 py-2 bg-white text-black font-bold rounded hover:bg-zinc-200 transition">Send Vibe</button>
            </div>
        </div>

        <div id="resize-handle" class="w-1 bg-zinc-800 hover:bg-blue-500 cursor-col-resize transition-colors flex-shrink-0"></div>

        <div class="flex-1 bg-white overflow-hidden">
            <iframe id="preview-frame" srcdoc="<body style='display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;'>Preview will appear here</body>"></iframe>
        </div>
    </main>

    <div id="auth-modal" class="fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-900 p-6 rounded-lg w-full max-w-sm border border-zinc-700">
            <h2 class="text-xl font-bold mb-4">Vibe Password</h2>
            <input id="auth-password" type="password" placeholder="Enter password"
                class="w-full bg-zinc-800 p-2 mb-4 rounded border border-zinc-700 focus:outline-none focus:border-blue-500">
            <button onclick="submitAuth()" class="w-full py-2 bg-blue-600 rounded font-bold hover:bg-blue-500">Enter</button>
            <p id="auth-error" class="text-red-400 text-sm mt-2 hidden">Incorrect password.</p>
        </div>
    </div>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-4">
        <div class="bg-zinc-900 p-6 rounded-lg w-full max-w-md border border-zinc-700">
            <h2 class="text-xl font-bold mb-4">Settings</h2>
            <input id="claude-key" type="password" placeholder="Claude API Key" class="w-full bg-zinc-800 p-2 mb-2 rounded border border-zinc-700">
            <input id="gh-token" type="password" placeholder="GitHub PAT (with repo access)" class="w-full bg-zinc-800 p-2 mb-2 rounded border border-zinc-700">
            <input id="gh-repo" type="text" placeholder="username/repo-name" class="w-full bg-zinc-800 p-2 mb-4 rounded border border-zinc-700">
            <button onclick="saveSettings()" class="w-full py-2 bg-blue-600 rounded font-bold">Save & Close</button>
        </div>
    </div>

    <script>
      // --- SECURE HASHED PROTECTION ---
      // This is the SHA-256 hash of the password "vibe123" 
      // (You should generate your own hash and replace this string!)
      const PASSWORD_HASH = "77A4ABD9C79251BAC0797CD97AA89B0B413AC48D36264A53235BE48FC9198FB3";

      async function sha256(message) {
          const msgBuffer = new TextEncoder().encode(message);
          const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
          const hashArray = Array.from(new Uint8Array(hashBuffer));
          return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      }

      const authModal = document.getElementById('auth-modal');
      if (sessionStorage.getItem('vibe_auth') === 'true') {
          authModal.classList.add('hidden');
      }

      document.getElementById('auth-password').addEventListener('keydown', e => {
          if (e.key === 'Enter') submitAuth();
      });

      async function submitAuth() {
          const pass = document.getElementById('auth-password').value;
          const hashedInput = await sha256(pass);
          if (hashedInput.toUpperCase() === PASSWORD_HASH) {
              sessionStorage.setItem('vibe_auth', 'true');
              authModal.classList.add('hidden');
          } else {
              document.getElementById('auth-error').classList.remove('hidden');
              document.getElementById('auth-password').value = '';
              document.getElementById('auth-password').focus();
          }
      }
      // --- END PROTECTION ---
      
        let currentCode = "";

        // Load index.html into preview and seed currentCode
        fetch('index.html')
            .then(r => r.text())
            .then(html => {
                currentCode = html;
                document.getElementById('preview-frame').srcdoc = html;
            })
            .catch(() => {});

        // UI Logic
        function toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }
        function saveSettings() {
            localStorage.setItem('vibe_claude_key', document.getElementById('claude-key').value);
            localStorage.setItem('vibe_gh_token', document.getElementById('gh-token').value);
            localStorage.setItem('vibe_gh_repo', document.getElementById('gh-repo').value);
            toggleSettings();
            checkSettings();
        }

        function checkSettings() {
            const settings = [
                { key: 'vibe_claude_key', label: 'Claude API Key' },
                { key: 'vibe_gh_token', label: 'GitHub Token' },
                { key: 'vibe_gh_repo', label: 'GitHub Repo' },
            ];
            const missing = settings.filter(s => !localStorage.getItem(s.key));
            const history = document.getElementById('chat-history');
            history.innerHTML = '';
            if (missing.length === 0) {
                const div = document.createElement('div');
                div.className = 'text-green-400 text-sm';
                div.textContent = '✓ All settings configured. Ready to vibe.';
                history.appendChild(div);
            } else {
                const div = document.createElement('div');
                div.className = 'text-yellow-400 text-sm';
                div.innerHTML = `Missing settings — open Settings to configure:<br>` +
                    missing.map(s => `&nbsp;&nbsp;• ${s.label}`).join('<br>');
                history.appendChild(div);
            }
        }

        checkSettings();

        document.getElementById('vibe-input').addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.altKey) {
                e.preventDefault();
                sendVibe();
            }
        });

        function addChatMessage(role, text) {
            const div = document.createElement('div');
            div.className = role === 'user' ? 'text-blue-400' : 'text-zinc-300';
            div.innerHTML = `<strong>${role.toUpperCase()}:</strong> ${text}`;
            document.getElementById('chat-history').appendChild(div);
            document.getElementById('chat-history').scrollTop = document.getElementById('chat-history').scrollHeight;
        }

        function showThinking() {
            const div = document.createElement('div');
            div.id = 'thinking-indicator';
            div.className = 'text-zinc-400 text-sm flex items-center gap-2';
            div.innerHTML = `<strong>CLAUDE:</strong> <span class="flex gap-1">
                <span class="thinking-dot w-1.5 h-1.5 rounded-full bg-zinc-400 inline-block"></span>
                <span class="thinking-dot w-1.5 h-1.5 rounded-full bg-zinc-400 inline-block"></span>
                <span class="thinking-dot w-1.5 h-1.5 rounded-full bg-zinc-400 inline-block"></span>
            </span>`;
            document.getElementById('chat-history').appendChild(div);
            document.getElementById('chat-history').scrollTop = document.getElementById('chat-history').scrollHeight;
        }

        function hideThinking() {
            const el = document.getElementById('thinking-indicator');
            if (el) el.remove();
        }

        function playChime() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const frequencies = [880, 1108.73]; // A5 → C#6
            frequencies.forEach((freq, i) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'sine';
                osc.frequency.value = freq;
                const start = ctx.currentTime + i * 0.12;
                gain.gain.setValueAtTime(0, start);
                gain.gain.linearRampToValueAtTime(0.18, start + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.0001, start + 0.6);
                osc.start(start);
                osc.stop(start + 0.6);
            });
        }

        // The "Vibe" Logic
        async function sendVibe() {
            const input = document.getElementById('vibe-input');
            const btn = document.getElementById('send-btn');
            const prompt = input.value;
            if(!prompt) return;

            input.value = "";
            btn.disabled = true;
            btn.innerText = "Claude is vibing...";
            addChatMessage('user', prompt);
            showThinking();

            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "x-api-key": localStorage.getItem('vibe_claude_key'),
                        "anthropic-version": "2023-06-01",
                        "content-type": "application/json",
                        "anthropic-dangerous-direct-browser-access": "true"
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-6",
                        max_tokens: 4000,
                        system: "You are a website builder. Return ONLY the full source code of a single-file HTML website including Tailwind CSS (via CDN) and any necessary JS. Do not explain anything.",
                        messages: [{ role: "user", content: `Current Code: ${currentCode}\n\nTask: ${prompt}` }]
                    })
                });

                const data = await response.json();
                currentCode = data.content[0].text.replace(/^```[\w]*\n?/, '').replace(/\n?```$/, '');
                document.getElementById('preview-frame').srcdoc = currentCode;
                hideThinking();
                playChime();
                addChatMessage('claude', "Updated preview!");
            } catch (err) {
                hideThinking();
                addChatMessage('claude', "Error: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "Send Vibe";
            }
        }

        // The GitHub Logic
        async function publishToGithub() {
            const btn = document.getElementById('publish-btn');
            const token = localStorage.getItem('vibe_gh_token');
            const repo = localStorage.getItem('vibe_gh_repo');
            
            if(!currentCode) return alert("Nothing to publish yet!");
            
            btn.innerText = "Publishing...";
            try {
                // Get SHA of index.html
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/index.html`, {
                    headers: { "Authorization": `token ${token}` }
                });
                const fileData = await res.json();

                // Update File
                await fetch(`https://api.github.com/repos/${repo}/contents/index.html`, {
                    method: "PUT",
                    headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        message: "Vibe update",
                        content: btoa(unescape(encodeURIComponent(currentCode))), // Fix for special characters
                        sha: fileData.sha
                    })
                });
                alert("Published! It may take 1 minute to refresh on your live URL.");
            } catch (err) {
                alert("GitHub Error: " + err.message);
            } finally {
                btn.innerText = "Publish to GitHub";
            }
        }

        // Sidebar resize
        (function() {
            const handle = document.getElementById('resize-handle');
            const sidebar = document.getElementById('sidebar');
            const main = document.getElementById('main-panel');

            handle.addEventListener('pointerdown', e => {
                handle.setPointerCapture(e.pointerId);
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            handle.addEventListener('pointermove', e => {
                if (!handle.hasPointerCapture(e.pointerId)) return;
                const mainRect = main.getBoundingClientRect();
                const newWidth = Math.min(Math.max(e.clientX - mainRect.left, 200), mainRect.width - 200);
                sidebar.style.width = newWidth + 'px';
            });

            handle.addEventListener('pointerup', e => {
                handle.releasePointerCapture(e.pointerId);
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            });
        })();
    </script>
</body>
</html>