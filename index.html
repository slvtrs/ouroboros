<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vibe Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #preview-frame { width: 100%; height: 100%; border: none; background: white; }
        @keyframes thinking-bounce {
            0%, 80%, 100% { opacity: 0.2; transform: translateY(0); }
            40% { opacity: 1; transform: translateY(-3px); }
        }
        .thinking-dot { animation: thinking-bounce 1.2s infinite ease-in-out; }
        .thinking-dot:nth-child(2) { animation-delay: 0.2s; }
        .thinking-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes ouroboros-rotate { to { transform: rotate(360deg); } }
        .ouroboros-spin {
            animation: ouroboros-rotate 20s linear infinite;
            transform-box: fill-box;
            transform-origin: center;
            transition: opacity 0.3s;
        }
        #edit-btn:hover .ouroboros-spin { animation-duration: 4s; }
        .ouroboros-spin.spin-fast { animation-duration: 0.38s !important; }
    </style>
</head>
<body class="h-screen bg-white overflow-hidden">

    <!-- Full-screen preview -->
    <iframe id="preview-frame" src="content.html" class="w-full h-full border-none block"></iframe>

    <!-- Floating Transmute button -->
    <button onclick="toggleChat()" id="edit-btn"
        class="fixed bottom-6 left-6 px-5 py-2.5 bg-zinc-900 text-white text-sm font-bold tracking-widest rounded-full shadow-xl z-40 border border-zinc-700 opacity-40 hover:opacity-100 transition-opacity">
        TRANSMUTE
    </button>

    <!-- Chat popup -->
    <div id="chat-popup" class="hidden fixed bottom-24 left-6 w-80 flex flex-col bg-zinc-950 border border-zinc-700 rounded-xl shadow-2xl z-50 overflow-hidden" style="height: 520px;">

        <div class="px-4 pt-4 pb-3 border-b border-zinc-800 flex items-center justify-between flex-shrink-0">
            <div class="flex items-center gap-2">
                <svg id="ouroboros-svg" class="ouroboros-spin w-6 h-6 flex-shrink-0" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <path d="M 41.5 81.9 A 33 33 0 1 1 58.5 81.9" fill="none" stroke="white" stroke-width="9" stroke-linecap="butt"/>
                    <ellipse cx="66.5" cy="79" rx="11" ry="5.8" transform="rotate(-15 66.5 79)" fill="white"/>
                    <ellipse cx="59.5" cy="81.9" rx="3.5" ry="3.2" fill="#18181b"/>
                    <path d="M 57 82 L 49 82 M 49 82 L 46 79.5 M 49 82 L 46 84.5" stroke="#f87171" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                    <path d="M 42.7 77.6 Q 52 79 57 82 Q 52 85.5 40.3 86.3 Z" fill="white"/>
                </svg>
                <h1 class="font-bold tracking-tighter text-xl text-white">SORO<span class="X-text-blue-500">BO<span style="display:inline-block;transform:scaleX(-1)">R</span>UO</span></h1>
            </div>
            <div class="flex items-center gap-1">
                <button onclick="toggleAbout()" title="About" class="text-zinc-400 hover:text-white transition-colors p-1 rounded hover:bg-zinc-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                </button>
                <button onclick="toggleSettings()" title="Settings" class="text-zinc-400 hover:text-white transition-colors p-1 rounded hover:bg-zinc-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </button>
                <button onclick="toggleChat()" title="Close" class="text-zinc-400 hover:text-white transition-colors p-1 rounded hover:bg-zinc-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
        </div>

        <div id="chat-history" class="flex-1 p-4 overflow-y-auto space-y-4 text-sm text-white">
        </div>

        <div class="p-4 border-t border-zinc-800 flex-shrink-0">
            <textarea id="vibe-input" placeholder="e.g. 'Make it a dark mode portfolio with neon pink accents...'"
                class="w-full bg-zinc-900 border border-zinc-700 rounded p-2 focus:outline-none focus:border-blue-500 h-20 resize-none text-sm text-white"></textarea>
            <button onclick="sendVibe()" id="send-btn" class="w-full mt-2 py-2 bg-white text-black font-bold rounded hover:bg-zinc-200 transition text-sm">Send</button>
            <button onclick="publishToGithub()" id="publish-btn" class="hidden w-full mt-2 py-2 bg-blue-600 font-bold rounded hover:bg-blue-500 transition text-sm text-white">Publish to GitHub</button>
        </div>
    </div>

    <!-- Settings modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-900 p-6 rounded-lg w-full max-w-md border border-zinc-700">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white">Settings</h2>
                <button onclick="toggleSettings()" class="text-zinc-400 hover:text-white transition-colors p-1 rounded hover:bg-zinc-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <input id="claude-key" type="password" placeholder="Claude API Key" class="w-full bg-zinc-800 p-2 mb-2 rounded border border-zinc-700 text-white">
            <input id="gh-token" type="password" placeholder="GitHub PAT (with repo access)" class="w-full bg-zinc-800 p-2 mb-4 rounded border border-zinc-700 text-white">
            <button onclick="saveSettings()" class="w-full py-2 bg-blue-600 rounded font-bold text-white">Save & Close</button>
        </div>
    </div>

    <!-- About modal -->
    <div id="about-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-900 p-6 rounded-lg w-full max-w-md border border-zinc-700">
            <div class="flex items-center justify-between mb-5">
                <h2 class="text-xl font-bold text-white tracking-tight">The Ouroboros Principle</h2>
                <button onclick="toggleAbout()" class="text-zinc-400 hover:text-white transition-colors p-1 rounded hover:bg-zinc-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="space-y-4 text-sm text-zinc-300 leading-relaxed">
                <p>The serpent devours its own tail — not in destruction, but in eternal renewal. From its consumption, it is remade.</p>
                <p>This page is such a serpent. It contains within itself the intelligence to rewrite itself. What you see is both the vessel and the venom — the site holds the editor that transforms the site.</p>
                <p>Speak your intention into the void. A vast intelligence will digest the current form and breathe back something new — the old code consumed, the new code born from it. Each transmutation remembers what came before and becomes something it could not have been without it.</p>
                <p>When the vision is complete, publish it — and the live form updates, shedding its previous skin across the network.</p>
                <p class="text-zinc-500 italic">That which rewrites itself cannot be said to die.</p>
            </div>
        </div>
    </div>

    <script>
        let currentCode = "";
        let lastPrompt = "";
        let hasUnpublishedChanges = false;

        function triggerSpin() {
            const svg = document.getElementById('ouroboros-svg');
            svg.classList.add('spin-fast');
            // 3 rotations at 0.38s each = ~1.14s, then ease back to slow
            setTimeout(() => svg.classList.remove('spin-fast'), 1140);
        }

        function toggleChat() {
            const popup = document.getElementById('chat-popup');
            const isHidden = popup.classList.toggle('hidden');
            if (!isHidden) checkSettings();
            triggerSpin();
        }

        function navigateHome() {
            if (hasUnpublishedChanges && !confirm("You have unpublished changes that will be lost. Leave anyway?")) return;
            window.location.href = "content.html";
        }

        window.addEventListener('beforeunload', e => {
            if (hasUnpublishedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Seed currentCode with content.html so Claude has context from the first message
        fetch('content.html')
            .then(r => r.text())
            .then(html => { currentCode = html; })
            .catch(() => {});

        // UI Logic
        function toggleAbout() { document.getElementById('about-modal').classList.toggle('hidden'); }
        function toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }
        function saveSettings() {
            localStorage.setItem('vibe_claude_key', document.getElementById('claude-key').value);
            localStorage.setItem('vibe_gh_token', document.getElementById('gh-token').value);
            toggleSettings();
            checkSettings();
        }

        function checkSettings() {
            const settings = [
                { key: 'vibe_claude_key', label: 'Claude API Key' },
                { key: 'vibe_gh_token', label: 'GitHub Token' },
            ];
            const missing = settings.filter(s => !localStorage.getItem(s.key));
            const history = document.getElementById('chat-history');
            history.innerHTML = '';
            if (missing.length === 0) {
                const div = document.createElement('div');
                div.className = 'text-green-400 text-sm';
                div.textContent = '✓ All settings configured. Ready to vibe.';
                history.appendChild(div);
            } else {
                const div = document.createElement('div');
                div.className = 'text-yellow-400 text-sm';
                div.innerHTML = `Missing settings — open Settings to configure:<br>` +
                    missing.map(s => `&nbsp;&nbsp;• ${s.label}`).join('<br>');
                history.appendChild(div);
            }
        }

        document.getElementById('vibe-input').addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.altKey) {
                e.preventDefault();
                sendVibe();
            }
        });

        function addChatMessage(role, text) {
            const div = document.createElement('div');
            div.className = role === 'user' ? 'text-blue-400' : role === 'error' ? 'text-red-400' : 'text-zinc-300';
            div.innerHTML = `<strong>${role === 'error' ? 'ERROR' : role.toUpperCase()}:</strong> ${text}`;
            document.getElementById('chat-history').appendChild(div);
            document.getElementById('chat-history').scrollTop = document.getElementById('chat-history').scrollHeight;
        }

        function showThinking() {
            const div = document.createElement('div');
            div.id = 'thinking-indicator';
            div.className = 'text-zinc-400 text-sm flex items-center gap-2';
            div.innerHTML = `<strong>CLAUDE:</strong> <span class="flex gap-1">
                <span class="thinking-dot w-1.5 h-1.5 rounded-full bg-zinc-400 inline-block"></span>
                <span class="thinking-dot w-1.5 h-1.5 rounded-full bg-zinc-400 inline-block"></span>
                <span class="thinking-dot w-1.5 h-1.5 rounded-full bg-zinc-400 inline-block"></span>
            </span>`;
            document.getElementById('chat-history').appendChild(div);
            document.getElementById('chat-history').scrollTop = document.getElementById('chat-history').scrollHeight;
        }

        function hideThinking() {
            const el = document.getElementById('thinking-indicator');
            if (el) el.remove();
        }

        function playChime() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const frequencies = [880, 1108.73]; // A5 → C#6
            frequencies.forEach((freq, i) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'sine';
                osc.frequency.value = freq;
                const start = ctx.currentTime + i * 0.12;
                gain.gain.setValueAtTime(0, start);
                gain.gain.linearRampToValueAtTime(0.18, start + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.0001, start + 0.6);
                osc.start(start);
                osc.stop(start + 0.6);
            });
        }

        // The "Vibe" Logic
        async function sendVibe() {
            const input = document.getElementById('vibe-input');
            const btn = document.getElementById('send-btn');
            const prompt = input.value;
            if (!prompt) return;

            const missing = [
                { key: 'vibe_claude_key', label: 'Claude API Key' },
            ].filter(s => !localStorage.getItem(s.key));
            if (missing.length) {
                addChatMessage('error', `Missing required settings: ${missing.map(s => s.label).join(', ')} — open Settings to configure.`);
                return;
            }

            lastPrompt = prompt;
            input.value = "";
            btn.disabled = true;
            btn.innerText = "Claude is vibing...";
            addChatMessage('user', prompt);
            showThinking();

            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "x-api-key": localStorage.getItem('vibe_claude_key'),
                        "anthropic-version": "2023-06-01",
                        "content-type": "application/json",
                        "anthropic-dangerous-direct-browser-access": "true"
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-6",
                        max_tokens: 4000,
                        system: "You are a website builder. Return ONLY the full source code of a single-file HTML website including Tailwind CSS (via CDN) and any necessary JS. Do not explain anything.",
                        messages: [{ role: "user", content: `Current Code: ${currentCode}\n\nTask: ${prompt}` }]
                    })
                });

                const data = await response.json();
                currentCode = data.content[0].text.replace(/^```[\w]*\n?/, '').replace(/\n?```$/, '');
                document.getElementById('preview-frame').srcdoc = currentCode;
                hasUnpublishedChanges = true;
                document.getElementById('publish-btn').classList.remove('hidden');
                hideThinking();
                playChime();
                addChatMessage('claude', "Updated preview!");
            } catch (err) {
                hideThinking();
                addChatMessage('error', err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "Send";
            }
        }

        // The GitHub Logic
        async function publishToGithub() {
            const btn = document.getElementById('publish-btn');
            const token = localStorage.getItem('vibe_gh_token');
            const repo = "slvtrs/ouroboros";
            
            if(!currentCode) return alert("Nothing to publish yet!");
            
            btn.innerText = "Publishing...";
            try {
                // Get SHA of content.html
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/content.html`, {
                    headers: { "Authorization": `token ${token}` }
                });
                const fileData = await res.json();

                // Update File
                await fetch(`https://api.github.com/repos/${repo}/contents/content.html`, {
                    method: "PUT",
                    headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        message: lastPrompt ? lastPrompt.slice(0, 72) : "Vibe update",
                        content: btoa(unescape(encodeURIComponent(currentCode))), // Fix for special characters
                        sha: fileData.sha
                    })
                });
                hasUnpublishedChanges = false;
                document.getElementById('publish-btn').classList.add('hidden');
                alert("Published! It may take 1 minute to refresh on your live URL.");
            } catch (err) {
                alert("GitHub Error: " + err.message);
            } finally {
                btn.innerText = "Publish to GitHub";
            }
        }

        // Revert last commit
        async function revertLastCommit() {
            const btn = document.getElementById('revert-btn');
            const token = localStorage.getItem('vibe_gh_token');
            const repo = "slvtrs/ouroboros";

            if (!token || !repo) return alert("GitHub Token and Repo must be set in Settings.");
            if (!confirm("This will revert content.html to the previous commit and push it. Continue?")) return;

            btn.innerText = "Reverting...";
            btn.disabled = true;
            try {
                // Get the last two commits touching content.html
                const commitsRes = await fetch(`https://api.github.com/repos/${repo}/commits?path=content.html&per_page=2`, {
                    headers: { "Authorization": `token ${token}` }
                });
                const commits = await commitsRes.json();
                if (!commits[1]) return alert("No previous commit to revert to.");

                const prevSha = commits[1].sha;
                const prevMessage = commits[1].commit.message;

                // Get the file content at that commit
                const prevFileRes = await fetch(`https://api.github.com/repos/${repo}/contents/content.html?ref=${prevSha}`, {
                    headers: { "Authorization": `token ${token}` }
                });
                const prevFile = await prevFileRes.json();

                // Get current file SHA (needed for the update)
                const currFileRes = await fetch(`https://api.github.com/repos/${repo}/contents/content.html`, {
                    headers: { "Authorization": `token ${token}` }
                });
                const currFile = await currFileRes.json();

                // Push the old content as a new commit
                await fetch(`https://api.github.com/repos/${repo}/contents/content.html`, {
                    method: "PUT",
                    headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        message: `Revert to: ${prevMessage}`,
                        content: prevFile.content.replace(/\n/g, ''),
                        sha: currFile.sha
                    })
                });

                // Update local preview and code to match
                const reverted = atob(prevFile.content.replace(/\n/g, ''));
                currentCode = reverted;
                document.getElementById('preview-frame').srcdoc = reverted;
                hasUnpublishedChanges = false;
                document.getElementById('publish-btn').classList.add('hidden');
                addChatMessage('claude', `Reverted to: "${prevMessage}"`);
            } catch (err) {
                alert("Revert failed: " + err.message);
            } finally {
                btn.innerText = "Revert";
                btn.disabled = false;
            }
        }

    </script>
</body>
</html>